SELECT 
    t.transaction_id,
    t.date,
    t.branch_id,
    t.branch_name,
    t.kota,
    t.provinsi,
    t.rating_cabang,
    t.customer_name,
    t.product_id,
    t.product_name,
    t.actual_price,
    t.discount_percentage,
    t.persentase_gross_laba,
    t.actual_price AS nett_sales,
    t.actual_price * t.persentase_gross_laba AS nett_profit,
    t.rating_transaksi
FROM (
    SELECT 
        ft.transaction_id,
        ft.date,
        ft.branch_id,
        kc.branch_name,
        kc.kota,
        kc.provinsi,
        kc.rating AS rating_cabang,
        ft.customer_name,
        ft.product_id,
        p.product_name,
        (ft.price - (ft.price * ft.discount_percentage)) AS actual_price,
        ft.discount_percentage,
        CASE 
            WHEN ft.price <= 50000 THEN 0.10
            WHEN ft.price BETWEEN 50001 AND 100000 THEN 0.15
            WHEN ft.price BETWEEN 100001 AND 300000 THEN 0.20
            WHEN ft.price BETWEEN 300001 AND 500000 THEN 0.25
            WHEN ft.price > 500001 THEN 0.30
        END AS persentase_gross_laba,
        ft.rating AS rating_transaksi
    FROM rakamin-kf-analytics-479608.kimia_farma.kf_final_transaction ft
    LEFT JOIN rakamin-kf-analytics-479608.kimia_farma.kf_product p ON ft.product_id = p.product_id
    LEFT JOIN rakamin-kf-analytics-479608.kimia_farma.kf_kantor_cabang kc ON ft.branch_id = kc.branch_id
) t;
